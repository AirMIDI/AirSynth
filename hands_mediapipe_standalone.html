<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/webmidi@latest/dist/iife/webmidi.iife.js"></script>
    <script src="midi.js"></script>
    <link rel="stylesheet" href="styles.css"></link>
    <script type="module">
        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementsByClassName('output_canvas')[0];
        const canvasCtx = canvasElement.getContext('2d');

        let previousNote = 0;

        let showVideo = true;

        let gestureId = 1;

        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            // mirror the video output
            canvasCtx.translate(canvasElement.width, 0);
            canvasCtx.scale(-1, 1);

            let selectedPort = document.getElementById("outputs").value;
            let midiout = WebMidi.outputs[selectedPort];

            if(showVideo){
                canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            }

            if (results.multiHandLandmarks.length > 0) {
                let indexTipPos = results.multiHandLandmarks[0][8];
                let posX = indexTipPos.x * canvasElement.width;
                let posY = indexTipPos.y * canvasElement.height;

                let info = getPointVelocity(posX, posY);
                if(info.vx < -150 && info.distanceTraveled > 150){
                    console.log("swiped right");
                    startGesture();
                }
                if(info.vx > 150 && info.distanceTraveled > 150){
                    console.log("swiped left");
                    if(gestureId < 4){
                        gestureId += 1;
                    }
                    else {
                        gestureId = 0;
                    }
                }



                checkForGestureStartOrEnd(posX, posY);
                drawGestureDetectionStatus(canvasCtx, canvasElement);

                
    
                doSliderGestureIfActive(posX, posY, midiout, gestureId);
                drawOutputStatus();
               
                drawGestureActiveStatus(canvasCtx, canvasElement);

                for (const landmarks of results.multiHandLandmarks) {
                    drawLandmarks(canvasCtx, landmarks, {
                        color: '#FF0000',
                        lineWidth: 2
                    });
                }
            }
            canvasCtx.restore();
        }

        const hands = new Hands({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }
        });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({ image: videoElement });
            },
            width: 1280,
            height: 720
        });
        camera.start();

        document.querySelector('#videotoggle').addEventListener('change', () => {
            showVideo = !showVideo;
        });

        for(let i=0;i<5;i++){
            document.getElementById(`b${i+1}`).addEventListener('click', () => {
                gestureId = i;
            });
        }

    </script>
</head>

<body>
    <div class="panel">
        
        <div class="options">
            <h1>CONFIG</h1>
            <!-- always on mode option? -->

            <div>
                <label for="outputs">MIDI port output</label>
                <select name="outputs" id="outputs"></select>
            </div>
            <div>
                <label for="videotoggle">Enable video</label>
                <input type="checkbox" id="videotoggle" checked>
            </div>
            <div>
                <label for="G0">G1 CC</label>
                <input type="number" max="127" min="0" placeholder="MIDI CC 0-127" value="101" id="G0" onchange="updateGestureCC(0, this.value)">
            </div>
            <div>
                <label for="G1">G2 CC</label>
                <input type="number" max="127" min="0" placeholder="MIDI CC 0-127" value="102"id="G1" onchange="updateGestureCC(1, this.value)">
            </div>
            <div>
                <label for="G2">G3 CC</label>
                <input type="number" max="127" min="0" placeholder="MIDI CC 0-127" value="103" id="G2" onchange="updateGestureCC(2, this.value)">
            </div>            
            <div>
                <label for="G3">G4 CC</label>
                <input type="number" max="127" min="0" placeholder="MIDI CC 0-127" value="104" id="G3" onchange="updateGestureCC(3, this.value)">
            </div>
            <div>
                <label for="G4">G5 CC</label>
                <input type="number" max="127" min="0" placeholder="MIDI CC 0-127" value="105" id="G4" onchange="updateGestureCC(4, this.value)">
            </div>
            <button id="b1">switch to gesture 1</button>
            <button id="b2">switch to gesture 2</button>
            <button id="b3">switch to gesture 3</button>
            <button id="b4">switch to gesture 4</button>
            <button id="b5">switch to gesture 5</button>
        </div>

        <br>

        <div class="outputs">
            <h1>OUTPUT</h1>
            <div id="out">
                
            </div>
        </div>

    </div>
    <div class="container">
        <video class="input_video"></video>
        <canvas class="output_canvas" width="1280px" height="720px"></canvas>
    </div>
</body>

</html>